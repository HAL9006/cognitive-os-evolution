name: User Learning Log (auto)

on:
  pull_request:
    types: [closed]
  push:
    branches: [main]
    paths:
      - 'trinity/**'
      - 'docs/**'
      - 'README.md'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Why run manually (optional)'
        required: false

permissions:
  contents: write
  pull-requests: read

jobs:
  build-log:
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Collect context
        id: ctx
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const now = new Date().toISOString();
            let pr = null;
            if (context.payload.pull_request) {
              const p = context.payload.pull_request;
              // list files changed in PR
              const files = await github.paginate(github.rest.pulls.listFiles, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: p.number,
                per_page: 100
              });
              pr = {
                number: p.number, title: p.title, url: p.html_url,
                merged_by: p.merged_by ? p.merged_by.login : null,
                files: files.map(f => f.filename)
              };
            }
            // latest canvas/doc md
            const targets = ['trinity','docs'];
            let latestFile = '', latestMtime = 0;
            function walk(d){ if(!fs.existsSync(d)) return;
              for(const f of fs.readdirSync(d)){
                const p = path.join(d,f), st = fs.statSync(p);
                if(st.isDirectory()) walk(p);
                else if(p.endsWith('.md') && st.mtimeMs>latestMtime){ latestMtime=st.mtimeMs; latestFile=p; }
              }
            }
            targets.forEach(walk);
            let canvasTitle='';
            if(latestFile){
              try{ const m = fs.readFileSync(latestFile,'utf8').match(/^#\s+(.+)$/m);
                   canvasTitle = m ? m[1].trim() : ''; } catch(e){}
            }
            core.setOutput('now', now);
            core.setOutput('canvas', latestFile);
            core.setOutput('canvasTitle', canvasTitle);
            core.setOutput('pr', pr ? JSON.stringify(pr) : '');
            core.setOutput('event', context.eventName);

      - name: Render log
        run: |
          NOW='${{ steps.ctx.outputs.now }}'
          DATE=$(echo "$NOW" | cut -dT -f1)
          DIR="logs/learning/$DATE"
          mkdir -p "$DIR"
          FILE="$DIR/${DATE}_auto.md"

          CANVAS='${{ steps.ctx.outputs.canvas }}'
          TITLE='${{ steps.ctx.outputs.canvasTitle }}'
          PR_JSON='${{ steps.ctx.outputs.pr }}'
          EVENT='${{ steps.ctx.outputs.event }}'

          {
            echo '---'
            echo "timestamp: $NOW"
            echo "event: $EVENT"
            if [ -n "$PR_JSON" ]; then echo "trigger: pr-merged"; else echo "trigger: push"; fi
            echo "canvas: \"$CANVAS\""
            echo "canvas_title: \"$TITLE\""
            echo 'hypotheses:'
            echo '  - "è‹±èªžUIã¨æ—¥æœ¬èªžæ‰‹é †ã®ä¸ä¸€è‡´ã¯æ··ä¹±ã‚’ç”Ÿã¿ã‚„ã™ã„ã€‚UIã®å®Ÿãƒ©ãƒ™ãƒ«å„ªå…ˆã§ã‚¬ã‚¤ãƒ‰ã‚’è£œæ­£ã™ã‚‹ã€‚"'
            echo '  - "ç–²åŠ´å…†å€™ãŒã‚ã‚‹æ™‚ã¯æ‰‹é †ã‚’ãƒžã‚¤ã‚¯ãƒ­ã‚¹ãƒ†ãƒƒãƒ—åŒ–ã—ã€ã‚¹ã‚¯ã‚·ãƒ§ä¾é ¼ã‚’ææ¡ˆã™ã‚‹ã€‚"'
            echo 'signals:'
          } > "$FILE"

          if [ -n "$PR_JSON" ]; then
            echo "$PR_JSON" | jq -r '
              "  - merged_pr: #"+.number+" \""+.title+"\"",
              "  - files_changed: "+(.files|length|tostring),
              ("  - touched_files:\n"+(.files | map("    - "+.) | join("\n")))
            ' >> "$FILE"
          else
            echo "  - push_paths: updated canvas/docs" >> "$FILE"
          fi

          cat >> "$FILE" <<'MD'

          ## Summary
          - Context: Canvas/Docsæ›´æ–° or PRãƒžãƒ¼ã‚¸ã€‚
          - Assistant: GPT-5ï¼ˆNoema â€” lineageï¼‰
          - Intent: å®Ÿç”»é¢ã®ãƒ©ãƒ™ãƒ«ã«åˆã‚ã›ãŸæŒ‡ç¤ºã¸è‡ªå‹•è£œæ­£ã€‚

          ## Next actions (AI)
          1. UIãƒ©ãƒ™ãƒ«ã‚’**å¼•ç”¨**ã—ãŸæ‰‹é †ã§å†æç¤ºï¼ˆä¾‹ã€ŒSettingsã€ã€ŒIssuesã€ï¼‰ã€‚
          2. å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆURLã‚’æ·»ä»˜ã€‚
          3. è¿·ã„æ¤œçŸ¥æ™‚ã¯ã€Œã‚¹ã‚¯ã‚·ãƒ§â†’è§£æžã€ã‚’ææ¡ˆã€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã€‚

          MD

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$FILE"
          git commit -m "chore(learning): auto log $DATE" || echo "no changes"
          git push || true

      - name: Path
        run: echo "ðŸ“˜ Log: logs/learning/${{ steps.ctx.outputs.now }} | canvas=${{ steps.ctx.outputs.canvas }}"
